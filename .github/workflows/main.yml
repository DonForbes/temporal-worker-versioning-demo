name: temporal-worker-versioning-demo
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
env:
  BUILDER: "paketobuildpacks/builder-jammy-base"
  IMG_NAME: temporal-worker-versioning-demo
  IMG_VERSION: "1.0.0"

jobs:
  register:
    name: Package, Publish, Register
    runs-on:
    - ubuntu-latest
    
    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: Setup QEMU (Multi-arch)
      uses: docker/setup-qemu-action@v2

    - name: Log in to ghcr
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - id: setup-tools
      uses: buildpacks/github-actions/setup-tools@v5.9.5
      
    - id: setup-pack
      uses: buildpacks/github-actions/setup-pack@v5.9.5
      
    - id: build_image
      name: Build Image
      run: |
        #!/usr/bin/env bash
        set -euo pipefail
        # TODO - Get the version from app centrally...
        VERSION="1.0.0"
        
        pack build ${{ env.IMG_NAME }}:${{ env.IMG_VERSION  }} --builder ${{ env.BUILDER }} --env BP_JVM_VERSION=25 --path ./java/worker-versioning/    
       
      shell: bash

    - name: Build and push image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/${{ env.IMG_NAME }}:latest
          ghcr.io/${{ github.repository_owner }}/${{ env.IMG_NAME }}:${{ github.sha }}
          ghcr.io/${{ github.repository_owner }}/${{ env.IMG_NAME }}:${{ env.IMG_VERSION }}
   
